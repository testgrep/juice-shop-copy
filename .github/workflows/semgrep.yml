name: Semgrep xSarif

on:
  workflow_dispatch: {}
  # Uncomment the following lines as needed
  # pull_request: {}
  # push:
  #   branches:
  #     - main
  #     - master
  #   paths:
  #     - .github/workflows/semgrep.yml
  # schedule:
  #   - cron: "5 20 * * *"

jobs:
  prep:
    runs-on: ubuntu-20.04
    steps:
      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Pull Docker image
        run: docker pull ghcr.io/testgrep/cse-findings-sarif/semgrep-with-sarif-transform:latest

  semgrep:
    name: semgrep/ci
    needs: prep
    runs-on: ubuntu-20.04
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    container:
      image: ghcr.io/testgrep/cse-findings-sarif/semgrep-with-sarif-transform:latest
    steps:
      - uses: actions/checkout@v4
      - run: semgrep ci --json -o semgrep-findings.json
      - run: python /transform/semgrep-json-to-sarif.py --json ./semgrep-findings.json --sarif ./semgrep-sarif.json
      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif.json
          path: ./semgrep-sarif.json
      - name: Upload SARIF to GHAS Dashboard
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-sarif.json
        if: always()
